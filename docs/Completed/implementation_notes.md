# 実装ノート - 設計意図と判断の記録

このドキュメントは、実装時の設計判断、却下した代替案、ハマったポイントなど、**「なぜこう作ったか」**を記録するものです。

---

## 全体アーキテクチャ

### なぜGIMP 3プラグインとして実装したか

**理由:**
1. **既存ワークフローとの統合**: ユーザーは既にGIMPでタコグラフチャートを編集している
2. **ノンプログラマーでも使える**: GUIで操作できる
3. **手動補正との組み合わせ**: 自動処理後にGIMPの強力な編集機能で微調整可能
4. **依存関係ゼロ**: GIMPとPython標準ライブラリのみで動作

**却下した代替案:**
- **スタンドアロンアプリ**: OpenCV + Tkinter
  - 却下理由: GIMPの豊富な画像編集機能を捨てることになる
- **Webアプリ**: Flask + PIL
  - 却下理由: デスクトップワークフローに適さない、大容量画像のアップロードが非効率
- **CLIツール**: Click + Pillow
  - 却下理由: ノンプログラマーが使えない

---

## コア機能の設計判断

### 1. Split Padding と Ellipse Padding を分離

**判断:**
2つの独立したパディング設定を提供する。

**理由:**
原稿の歪みに対する調整ポイントが2箇所ある：
1. **Split Padding**: 切り出し時の余白（位置ズレ対策）
   - スキャン時の原稿配置のズレ
   - 切り出し境界の安全マージン
2. **Ellipse Padding**: 背景除去の内側余白（楕円の歪み対策）
   - 円盤自体の楕円度
   - 円盤の外周ノイズ除去

これらは**独立して調整する必要がある**ため、別パラメータにした。

**実例:**
- スキャン位置ズレが大きい → Split Padding = 30px
- 円盤外周のノイズが多い → Ellipse Padding = 25px
- スキャン精度が高く、外周ギリギリまで残したい → Split Padding = 15px, Ellipse Padding = 10px

**却下した代替案:**
- 単一のPaddingパラメータ → 柔軟性が低い
- 自動調整 → 原稿の状態が多様すぎて実装困難

### 2. ガイド分割（Split Using Guides）を削除

**判断:**
MVP版で実装していたガイドベースの切り分け機能を削除し、Auto Splitのみを提供。

**理由:**
1. **使用頻度**: Auto Splitが完成した後、ガイド分割は使われなくなった
2. **メンテナンスコスト**: 2つの分割方式を維持するコストが高い
3. **UIの複雑化**: ボタンが2つあるとユーザーが混乱する
4. **品質**: Auto Splitの精度が十分高い

**タイミング:**
v1.0.0リリース時に削除。正式版では不要と判断。

**却下した代替案:**
- 両方を残す → UIが複雑になり、メンテナンスコストが高い
- オプションで切り替え → 実用性が低い

### 3. しきい値スライダーの削除

**判断:**
背景除去のStep 2から、Thresholdスライダーを削除。

**理由:**
楕円選択ベースのアルゴリズムでは、しきい値が不要になった。
- 旧アルゴリズム: しきい値でバイナリ化 → Island検出
- 新アルゴリズム: 楕円選択 → 反転 → クリア（しきい値不要）

**ユーザー体験の改善:**
- 調整パラメータが減り、UIがシンプルに
- Ellipse Paddingのみで調整可能

---

## テキスト挿入機能の設計

### CSV日付の優先順位

**判断:**
日付の優先順位を以下の通りとする：
1. CSV内の`date`フィールド（YYYYMMDD形式）
2. CSV内の`date_year`, `date_month`, `date_day`フィールド
3. UI選択の日付（前回値があれば優先、無ければ当日）

**理由:**
- **柔軟性**: 車両ごとに異なる日付を設定可能
- **一括処理**: 同じ日付の場合、UI選択で一括設定
- **UX**: 前回値を記憶することで、連続作業がスムーズ

**実装:**
```python
# CSV優先
if 'date' in row:
    date_str = row['date']
elif 'date_year' in row:
    date_str = f"{row['date_year']}{row['date_month']}{row['date_day']}"
# UI選択フォールバック
else:
    date_str = ui_selected_date
```

### テンプレートフォルダのカスタマイズ

**判断:**
デフォルトテンプレートに加え、カスタムテンプレートフォルダを設定可能にする。

**理由:**
- ユーザーごとに異なるレイアウトニーズ
- デフォルトテンプレートを上書きせず、独自テンプレートを追加可能

**設定の保存:**
`%APPDATA%\tachograph_wizard\settings.json` に保存し、次回起動時に復元。

---

## UI/UX設計の意図

### ウィザード型ステップUI

**判断:**
Step 1 → Step 2 → Step 3 の順次実行型UI。

**理由:**
1. **分かりやすさ**: 処理の流れが明確
2. **確認ポイント**: 各ステップの結果を確認してから次へ進める
3. **やり直し可能**: Step 1に戻って再実行可能

**却下した代替案:**
- 一括実行ボタン → 中間結果が確認できない、失敗時のリカバリーが困難

### プレビュー機能（Text Inserter）

**判断:**
CSV行選択時に、挿入されるテキストをプレビュー表示。

**理由:**
- **誤操作防止**: 間違った行を選択していないか確認できる
- **データ確認**: CSVの内容が正しいか視覚的に確認

**実装:**
スピナーの値変更時に`on_row_changed()`コールバックでプレビュー更新。

---

## エラーハンドリング戦略

### 失敗時のフォールバック

**判断:**
エラーが発生しても、可能な限り処理を継続する。

**例: 背景除去の失敗**
```python
try:
    BackgroundRemover.process_background(layer, ellipse_padding)
except Exception as e:
    _debug_log(f"Background removal failed: {e}")
    # 処理を継続（背景が残った状態でも保存可能）
```

**理由:**
- **部分的な成功を許容**: 一部の円盤だけでも処理できれば価値がある
- **手動補正の余地**: GIMPで手動修正可能

**却下した代替案:**
- 厳格なエラーチェックで全て中断 → 一部の失敗で全体が無駄になる

### ユーザーへのフィードバック

**判断:**
エラーは`Gimp.message()`でダイアログ表示 + Error Consoleにログ出力。

**理由:**
- ダイアログ: ユーザーに即座に通知
- Error Console: 詳細なスタックトレースで開発者がデバッグ可能

---

## パフォーマンス最適化

### 画像処理の効率化

**判断:**
ピクセルレベルのアクセスを避け、GIMP APIのネイティブメソッドを使用。

**理由:**
- **速度**: C/C++実装のGIMP APIは高速
- **安定性**: Geglバッファアクセスより安定
- **コードの簡潔さ**: Pythonコードが短くなる

**例:**
```python
# ❌ 遅い: ピクセルごとに処理
for y in range(height):
    for x in range(width):
        if should_clear(x, y):
            set_pixel(x, y, transparent)

# ✅ 速い: GIMP APIで一括処理
image.select_ellipse(...)
Gimp.Selection.invert(image)
layer.edit_clear()
```

### テンプレートのキャッシュ

**判断:**
読み込んだテンプレートをメモリにキャッシュ。

**実装:**
```python
_template_cache: dict[str, dict] = {}

def load_template(name: str) -> dict:
    if name in _template_cache:
        return _template_cache[name]
    # ファイル読み込み
    _template_cache[name] = template
    return template
```

**理由:**
- 同じテンプレートを繰り返し読み込む場合の高速化
- ファイルI/Oの削減

---

## セキュリティ・堅牢性

### ファイル名のサニタイズ

**判断:**
CSV由来のファイル名を厳格にサニタイズ。

**実装:**
```python
def _sanitize_filename(name: str) -> str:
    # スペース → アンダースコア
    name = name.replace(" ", "_")
    # スラッシュ → アンダースコア（パス区切り文字の排除）
    name = name.replace("/", "_").replace("\\", "_")
    # 危険な文字を除去
    return "".join(c for c in name if c.isalnum() or c in ("_", "-"))
```

**理由:**
- **パストラバーサル攻撃防止**: `/`, `\`の除去
- **クロスプラットフォーム互換性**: Windows/Linux/macOSで安全
- **予期しないファイル作成防止**: 制御文字の排除

### CSVインジェクション対策

**判断:**
CSV解析にPython標準ライブラリの`csv`モジュールを使用。

**理由:**
- **エスケープ処理**: 自動的に処理される
- **信頼性**: 標準ライブラリは十分にテストされている

**却下した代替案:**
- 独自実装 → バグの温床、セキュリティリスク

---

## 開発・デバッグの工夫

### Python-Fuコンソールでの検証

**重要な教訓:**
コードを書く前に、**必ずPython-Fuコンソールで動作確認する**。

**失敗例:**
楕円選択が動かず、450行のワークアラウンドコードを書いてしまった。
後でPython-Fuコンソールで`image.select_ellipse()`を試したら、そのまま動作した。

**成功例:**
新しいAPI（`Gimp.Selection.invert()`など）を試す前に、Python-Fuコンソールで確認。
動作を確認してからプラグインコードに組み込む。

**ベストプラクティス:**
```python
# 1. Python-Fuコンソールで検証
image = Gimp.get_images()[0]
image.select_ellipse(Gimp.ChannelOps.REPLACE, 100, 100, 200, 200)
# → 動作確認

# 2. プラグインコードに組み込む
def my_function(image):
    image.select_ellipse(...)
```

### デバッグログの活用

**判断:**
重要な処理箇所に`_debug_log()`を配置。

**実装:**
```python
def _debug_log(msg: str) -> None:
    print(f"[TachoGraphWizard] {msg}")
```

**理由:**
- GIMP Error Consoleに出力されるため、デバッグが容易
- 本番環境でも有効（ユーザーサポート時に役立つ）

**ログ出力例:**
```python
_debug_log(f"Processing {len(images)} images")
_debug_log(f"Ellipse padding: {ellipse_padding}px")
_debug_log(f"Selection created: ({x}, {y}, {w}, {h})")
```

---

## 今後の機能拡張に向けて

### 実装しなかった機能と理由

#### 1. 回転補正の自動化
**理由:**
- 正確な基準線検出が困難（チャート紙の種類が多様）
- 手動補正（Correctiveモード）で十分
- ROIが低い

**将来の可能性:**
機械学習ベースの基準線検出（v2.0以降で検討）

#### 2. 複数円盤の同時処理（未分割画像）
**理由:**
- 画像分割が十分高速で正確
- 複雑なアルゴリズムになる
- ユーザーニーズが不明確

**将来の可能性:**
大量処理用のバッチモード（v1.x系で検討）

#### 3. OCR（文字認識）
**理由:**
- 依存関係が増える（Tesseract OCR）
- タコグラフチャートの文字は手書き・印字が混在し、精度が低い
- テンプレート+CSVで十分

**将来の可能性:**
低優先度（ユーザーフィードバック次第）

---

## 学んだ教訓

### 1. シンプルなアプローチを最初に試す

**教訓:**
複雑なアルゴリズムを実装する前に、シンプルな方法で解決できないか検討する。

**事例:**
背景除去で450行の複雑なコードを書いたが、楕円選択の40行で同じ結果が得られた。

### 2. 公式APIを信頼する

**教訓:**
「動かないだろう」と決めつけず、まずは公式APIを試す。

**事例:**
`image.select_ellipse()`が動かないと思い込み、ワークアラウンドを書いた。
実際には完璧に動作していた。

### 3. ドメイン知識を活用する

**教訓:**
問題のドメイン（タコグラフチャート = 円盤形状）を活用する。

**事例:**
汎用的な背景除去アルゴリズムではなく、円盤専用の楕円選択アルゴリズムを採用。

### 4. ユーザーに調整余地を残す

**教訓:**
完全自動化を目指すより、調整可能なパラメータを提供する。

**事例:**
Split Padding / Ellipse Paddingで柔軟に調整可能にした結果、多様な原稿に対応できた。

### 5. ドキュメントは「未来の自分」へのメッセージ

**教訓:**
実装時の意図、却下した代替案、ハマったポイントを記録する。

**このドキュメントの価値:**
- 数ヶ月後に見返したときに「なぜこう作ったか」を思い出せる
- 同じ間違いを繰り返さない
- 新しいメンバーへのオンボーディング資料

---

## 関連ドキュメント

- `docs/decisions/001-ellipse-based-background-removal.md` - 楕円選択ベース背景除去の詳細
- `docs/troubleshooting.md` - GIMP 3 API使用時の問題と解決策
- `docs/testing_strategy.md` - テスト戦略
- `CHANGELOG.md` - バージョン履歴
- `README.md` - ユーザー向けドキュメント

---

このドキュメントは、開発中に得た知見を記録したものです。新しい機能を追加する際は、同様に「なぜそう作ったか」を記録してください。
