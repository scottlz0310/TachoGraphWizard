# 次回計画（簡素化版フロー）

## 目的

- 既存の「分割→背景透明化→保存」から、**背景透明化＋ごみ取り**に集中する。
- ガイド分割はGIMP標準機能に任せ、プラグイン側は**補助的な処理**に専念する。
- 操作ステップを減らし、実務での試行回数を最小化する。

---

## 方向性（プラグイン分割の案）

1) **Cleanup + Transparency プラグイン**
   - 機能: ごみ取り（ノイズ除去）→ 背景透明化（Color to Alpha）
   - 対象: アクティブレイヤー or 選択中の複数レイヤー
   - UI: しきい値 + ノイズ除去強度の最低限
   - プレビューはスライダー操作中は更新せず、離した瞬間のみ更新する
   - 透明化部分の自動選択→選択反転は後回し（GIMP標準操作で代替）

2) **Rotate & Align プラグイン**
   - 機能: ガイドに合わせた回転補正
   - 操作: ガイドを配置 → ドラッグ操作で角度調整（UIは最小限）
   - 目的: ガイド線を基準に、円盤中心や水平線・垂直線の位置合わせを支援

3) **Template Text プラグイン**
   - 機能: テンプレートに従った文字入れ
   - 入力: Excelで作成したCSV（UTF-8）を基本にする
   - 出力: テキストレイヤー生成と所定位置配置

---

## 次回スコープ（Phase 1: Cleanup集中）

### 目標

- 分割ボタンを外し、**背景透明化フローのみ**を安定化させる。
- UIを「しきい値 + ノイズ除去」の2項目に絞る。
- しきい値挙動の再現性を上げる（0-100のUI値を0.0-1.0へ正規化）
- しきい値スライダーはドラッグ中は更新せず、離した瞬間だけ反映する。

### 実装候補

- `wizard_procedure.py`:
  - Split UIを削除
  - 背景透明化ボタンをメインの唯一アクションにする
- `background_remover.py`:
  - GEGL `color-to-alpha` のパラメータ整備
  - しきい値の実験ログ追加（必要に応じて）

---

## 次々回スコープ（Phase 2: Template Text）

### 目標

- 既存テンプレートを利用した文字入れの自動化
- 作業の最後にまとめて文字を入れられるようにする

### 実装候補

- `template_manager.py` と `text_renderer.py` を使った最小実装
- CSV差し込みを先に対応し、必要なら後からJSONも追加する

### テンプレート仕様（案）

- **共通フィールド**は固定キーで定義し、テンプレートごとに使用/不使用を切り替える
- **位置とフォントサイズのみ**がテンプレート差分（内容は共通）
- 座標は画像サイズに対する**比率**で保持（解像度が変わってもズレにくい）
- フォントサイズは短辺基準の比率で保持（例: `size_ratio`）

#### CSVの想定（1行=1枚）

- ヘッダー行は固定キー（例: `vehicle_type`, `vehicle_no`, `driver`, `date`）
- 空欄は未入力扱い（テンプレート側で非表示にできる）
- 日付は「年/月/日」に分割して配置できるよう、`date_year`, `date_month`, `date_day` を用意する

#### フィールド定義の例（キーは英字で統一）

- `vehicle_type`（車種名）
- `vehicle_no`（車両ナンバー）
- `driver`（運転者）
- `date`（日付）
- `date_year`（年）
- `date_month`（月）
- `date_day`（日）

---

## その次（Phase 3: Rotate & Align）

### 目標

- 当面はGIMP標準の回転ツールを使い、プラグイン実装は保留
- 必要になった場合に、回転補正のプラグイン化を検討する

### 実装候補

- 角度入力は行わず、プラグイン内プレビューのドラッグで角度決定
- プレビューサイズはウィンドウサイズに連動して可変にする
- 中心点はレイヤー中心がデフォルトで、Alt+クリックで再指定できる
- 中心点には縦横のガイド線（十字）をプレビュー領域いっぱいまで表示し、位置確認しやすくする
- プレビュー上でドラッグ→角度算出→プレビュー更新→適用で本レイヤーに反映

---

## 非目標（今回外すもの）

- 画像分割（GIMPのガイド/ギロチンに任せる）
- 回転補正プラグイン（GIMP標準ツールで代替）
- バッチ処理や自動円盤検出は後回し

---

## 未確定事項（要確認）

- 文字入れで使う共通フィールドの最終リスト
- 日付/車番などの表記ルール（例: `YYYY/MM/DD`、ハイフン含むか）
