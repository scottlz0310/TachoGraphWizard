# バージョンアップ計画: 自動ゴミ取り + 自動切り分け

## 目的
- 円盤のエッジを安定して抽出し、手動ガイドなしで切り分けを自動化する
- ゴミ（黒点）を安定して除去し、後工程の手作業を削減する

## 背景
- 入力はスキャナー出力PDFをGIMPでインポートして利用
- GIMP側のインポートDPIが実質的な解像度になるため、DPIやピクセルサイズが変動し得る
- 既存運用ではエッジ出しを優先し、四隅のゴミは残している

## 対象バージョン
- 初回リリース: 現在の実装を安定版としてリリース
- 次回バージョン（案: v0.2.0）: 自動ゴミ取り + 自動切り分けを追加

## 自動処理の方針
- 解析用にレイヤーを複製し、元画像には直接加工しない
- 軽いぼかし or メディアンで黒点を面として潰す
- しきい値で2値化し、円盤を前景として抽出
- 連結成分を抽出し、「円盤候補」だけを残す
  - 最大成分のみを残す方法が最も安定
  - 代替として面積しきい値による除外
- マスクを使って透明化・切り抜きを実行

## 動的しきい値の決定
### 基本戦略
- DPIが信頼できる場合:
  - `expected_diameter_px = (122〜125mm / 25.4) * dpi`
  - 最小許容直径を `expected_diameter_px * 0.7` とし、面積または外接矩形で判定
- DPIが不明・信用できない場合:
  - 連結成分の最大直径を基準に動的しきい値を決定
  - 最大成分の0.7倍以上の成分のみ採用

### 実用的な閾値の目安
- 200dpi（直径≈980px）の場合: 最小面積 0.3〜0.4M px
- 1500px相当の場合: 最小面積 0.7〜1.0M px
- しきい値は自動計算を基本とし、必要ならUIで微調整

## 切り分け方針
- 連結成分ごとに外接矩形で切り抜き
- 必要なら外接円で正規化
- 出力は固定サイズにリスケールするオプションを追加（ピクセル数安定化）

## UI/設定案
- 「自動切り分け」トグル
- DPI検知値の表示（信頼できない場合は警告）
- しきい値の自動/手動切替
- 最小直径（比率）と最小面積の調整
- 出力サイズ固定のオプション

## 実装ステップ
1. マスク生成の試作（ぼかし → しきい値 → 連結成分）
2. 最大成分抽出の安定化
3. 切り抜きと個別化の処理を追加
4. 自動しきい値の導入（DPI/最大成分ベース）
5. UIに設定を追加
6. 既存手順との比較評価

## 検証方法
- 既存データでの抽出精度
- 手動ガイドとの差分評価
- DPIが異なる取り込みでの安定性確認

## 初回リリース方針
- 今回は「計画のみ」整理
- 現在の実装を初回リリースとしてタグ付け
- 次回バージョンで自動化機能を実装・検証
